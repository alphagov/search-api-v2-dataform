config {
    type: "operations",
    schema: "search_api",
    name: "explicit",
    tags: ["search-monthly"]
}

DECLARE
  PARTITIONTIME TIMESTAMP;

BEGIN TRANSACTION;

SET
  PARTITIONTIME = TIMESTAMP_TRUNC((CURRENT_TIMESTAMP()),MONTH);

DELETE
FROM
  automated_evaluation_input.explicit
WHERE
  _PARTITIONTIME = PARTITIONTIME;

INSERT INTO
  automated_evaluation_input.explicit (_PARTITIONTIME,
    queryEntry)
SELECT
  PARTITIONTIME AS _PARTITIONTIME,
  STRUCT( query,
    ARRAY_AGG( STRUCT( uri,
        score )
    ORDER BY
      score DESC ) AS targets ) AS queryEntry
FROM
  automated_evaluation_input.explicit_source
GROUP BY
  query
LIMIT
  1000;

COMMIT TRANSACTION;
